{% extends "juegos/base_juegos.html" %}

{% block title %}üß† L√≥gica Matem√°tica{% endblock %}

{% block extrastyle %}
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
<style>
    :root {
      --fondo: linear-gradient(120deg, #20253f 10%, #36f2ff 110%);
      --carta: rgba(44, 59, 110, 0.94);
      --color-correcto: #2ecc71;
      --color-error: #f3c267;
      --opcion-bg: #404958;
      --opcion-hover: #00f0ff;
      --texto: #f2feff;
      --azul: #00d8ff;
      --footer-bg: rgba(32,44,76,0.93);
      --footer-border: #3ffbda;
      --footer-link: #36f1cc;
      --footer-link-hover-bg: linear-gradient(90deg,#43ffd0 0%,#1d4d6e 100%);
    }
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0; padding: 0;
      background: var(--fondo);
      font-family: 'Share Tech Mono', monospace;
      color: var(--texto);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding-bottom: 80px;
    }
    h1 {
      text-align: center;
      margin-top: 30px;
      font-size: 1.8em;
      letter-spacing: 1px;
      text-shadow: 0 3px 10px #0006;
      color: #66fff0;
    }
    .menu-juegos {
      margin-top: 18px;
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }
    .juego-btn {
      padding: 0.6em 1.2em;
      background: #113355;
      border: 2px solid transparent;
      border-radius: 10px;
      color: var(--azul);
      font-weight: 700;
      letter-spacing: 0.6px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 145px;
    }
    .juego-btn:hover {
      background: #22ffff33;
      border-color: #22ffff88;
    }
    .juego-btn.selected {
      background: var(--azul);
      color: #000;
      cursor: default;
    }
    .container {
      max-width: 480px;
      width: 95%;
      margin: 32px auto 80px auto;
      background: var(--carta);
      border-radius: 18px;
      padding: 32px 24px;
      box-shadow: 0 7px 28px #00f6ff22;
      backdrop-filter: blur(5px) saturate(140%);
    }
    .enunciado {
      text-align: center;
      font-size: 1.2em;
      line-height: 1.5;
      margin-bottom: 24px;
    }
    .opciones {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 14px;
    }
    .op-btn {
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      font-size: 1.08em;
      background: var(--opcion-bg);
      color: var(--texto);
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
      min-width: 120px;
    }
    .op-btn:hover {
      background: var(--opcion-hover);
      color: #000;
      transform: scale(1.05);
    }
    .op-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    .feedback {
      margin-top: 20px;
      font-size: 1.08em;
      text-align: center;
    }
    .correcto {
      color: var(--color-correcto);
    }
    .fallo {
      color: var(--color-error);
    }
    #siguiente {
      display: flex;
      margin: 24px auto 0;
      padding: 11px 24px;
      background: #00ffdb;
      color: #102742;
      border-radius: 10px;
      border: none;
      font-weight: bold;
      font-size: 1.05em;
      cursor: pointer;
      transition: background 0.2s;
    }
    #siguiente:hover {
      background: #69fff4;
    }
    .stat {
      margin-top: 20px;
      font-size: 0.96em;
      text-align: center;
      color: #88f;
    }
    /* Barra de navegaci√≥n inferior unificada */
    .menu-navegacion {
      width: 100vw;
      display: flex;
      gap: 13px;
      justify-content: center;
      align-items: stretch;
      background: var(--footer-bg);
      box-shadow: 0 -3px 21px #39ffd733;
      padding: 0.8em 0.6em 1.2em 0.8em;
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 12;
    }
    .menu-card {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      background: none;
      border-radius:14px;
      font-size: 1.16em;
      font-weight:bold;
      color: var(--footer-link);
      letter-spacing: .5px;
      border:2.2px solid transparent;
      box-shadow: 0 1px 7px #45fadf22;
      padding: 14px 10px;
      text-decoration: none;
      transition: background 0.16s, color 0.18s, box-shadow 0.12s, border 0.13s;
      outline: none;
      text-align: center;
    }
    .menu-card i { font-size: 1.44em; }
    .menu-card:hover, .menu-card:focus {
      background: var(--footer-link-hover-bg);
      color: #141f36;
      border:2.2px solid var(--footer-border);
      text-decoration: none;
      box-shadow:0 5px 18px #45fadf70;
    }
    @media (max-width: 400px) {
      .op-btn {
        padding: 9px 12px;
        font-size: 1em;
        min-width: 95px;
      }
    }
    <style>
    :root {
      --glass: rgba(44, 59, 110, 0.92);
      --carta: #363e63;
      --acierto: #2edfa7;
      --error: #e6785b;
      --click: #19fbde;
      --azul-claro: #34fcf2;
      --footer-bg: rgba(32,44,76,0.93);
      --footer-border: #3ffbda;
      --footer-link: #36f1cc;
      --footer-link-hover-bg: linear-gradient(90deg,#43ffd0 0%,#1d4d6e 100%);
    }
    html, body {
      margin: 0; padding: 0;
      min-width: 100vw; min-height: 100vh;
      background: linear-gradient(120deg,#212646 10%,#45fadf 90%);
      color: #f1feff;
      font-family: 'Share Tech Mono', monospace, Arial, sans-serif;
      width: 100vw; height: 100vh;
      overflow-x: hidden;
      display: flex; flex-direction: column;
      align-items: stretch; justify-content: flex-start;
    }
    h1 {
      margin: 2.2vw 0 0 0;
      text-align: center;
      color:#3ffbda;
      font-size:clamp(1.3em,4vw,2.1em);
      letter-spacing:2px;
      text-shadow:0 2px 16px #283a5a70;
    }
    #menu-juegos {
      margin: 2vw 0 1.2vw 0;
      display: flex; gap: 12px; justify-content: center;
      flex-wrap: wrap;
    }
    .juego-btn {
      padding: 0.6em 1.2em;
      background: #151f33;
      border: 2px solid transparent;
      border-radius: 9px;
      color: #26ffe2;
      font-weight: 700;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.17s;
      min-width: 120px;
      letter-spacing: 0.6px;
    }
    .juego-btn.selected,
    .juego-btn:disabled {
      background: #00cfff;
      color: #23272f;
      cursor: default;
      border: 2px solid #00cfff;
    }
    .juego-btn:hover:not(.selected) { background:#33fbee33;border-color:#33fbeec9; }
    #main-content {
      flex:1 1 0;
      display: flex; flex-direction: column;
      align-items:center; justify-content:flex-start;
    }
    #config {
      margin: 22px 0 8px 0;
      display: flex; gap:13px; flex-wrap:wrap; align-items:center; justify-content:center;
      background: var(--glass);
      border-radius: 12px;
      box-shadow:0 2px 17px #00f5ff18;
      padding: 10px 19px 8px 19px;
    }
    #config label { font-size:1em;font-weight:700;}
    #restart {
      background: #19fbde;
      color:#222b38;
      border-radius: 7px;
      border:none;
      font-size: 1em;
      font-weight: bold;
      padding: 8px 18px;
      box-shadow:0 2px 9px #3ffbda35;
      cursor:pointer;
      outline:none;
      transition: background 0.13s,color 0.15s;
    }
    #restart:hover { background:#24fdc980;color:#17333c; }
    #stats {
      margin: 18px 0 4px 0;
      padding: 8px 26px 8px 26px;
      background: #22ebff24;
      font-size: 1.04em;
      border-radius: 8px;
      box-shadow: 0 2px 8px #23ebef13;
      color:#cafffb;
      text-align: center;
    }
    #game-board {
      display:grid; gap:14px;
      justify-content:center;
      align-content:center;
      margin: 21px 0 16px 0;
      background: var(--glass);
      border-radius:18px;
      box-shadow:0 3px 21px #50ebff11;
      padding: 22px 12px;
      min-width: min(280px, 96vw);
      max-width: 99vw;
      transition:box-shadow 0.12s;
      user-select:none;
    }
    .card {
      width: clamp(52px,10vw,87px); height: clamp(52px,10vw,87px);
      background: #243858;
      color: #fff;
      font-size: clamp(1.6em,4.5vw,2.16em);
      border-radius: 13px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, box-shadow 0.25s;
      box-shadow: 0px 3px 13px #12123a45;
      user-select: none;
      will-change: transform;
      outline: none;
      position: relative;
      border:2.3px solid #00f5ff12;
    }
    .card.flipped, .card.matched {
      background: #12f2d2;
      color: #23272f;
      transform: scale(1.02) rotate(-1deg);
      z-index: 2;
      box-shadow: 0 6px 21px #00ffe93e, 0 2px 8px #24e5ffd0;
      border:2.3px solid #14efdbaa;
    }
    .card.matched {
      background: #26e87a;
      color:#224;
      animation: matchflash 0.45s linear;
    }
    @keyframes matchflash {
      0%{ box-shadow:0 0 18px #fff85b77; background:#aaffbf;}
      100%{ box-shadow:0 5px 14px #24e5ffd0;}
    }
    .card.flip-err {
      background: #e6785b;
      color: #fff9;
      animation: shake 0.38s linear;
    }
    @keyframes shake {
      0% { transform: rotate(0);}
      26% { transform: rotate(-6deg);}
      43% { transform: rotate(5deg);}
      70% { transform: rotate(-3deg);}
      100% { transform: rotate(0);}
    }
    #next-level {
      margin: 16px auto 0 auto;
      padding: 13px 34px;
      border: none;
      background: #23ffce;
      color: #191f28;
      border-radius: 9px;
      font-size: 1.13em;
      box-shadow:0 3px 17px #3cfadf44;
      font-weight:bold;
      cursor: pointer;
      transition: background 0.16s, color 0.13s, box-shadow 0.13s;
      display: none;
    }
    #next-level:disabled {
      background: #aac;
      color: #eee;
      cursor: not-allowed;
      filter: grayscale(.14);
      opacity: .7;
    }
    #next-level:hover:not(:disabled) {
      background: #63ffd7;
      color: #232;
      box-shadow:0 5px 18px #2cfadf65;
    }
    /* Barra de navegaci√≥n inferior igualada */
    .menu-navegacion {
      width: 100vw;
      display: flex;
      gap: 13px;
      justify-content: center;
      align-items: stretch;
      background: var(--footer-bg);
      box-shadow: 0 -3px 21px #39ffd733;
      padding: 0.8em 0.6em 1.2em 0.8em;
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 12;
    }
    .menu-card {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      background: none;
      border-radius:14px;
      font-size: 1.16em;
      font-weight:bold;
      color: var(--footer-link);
      letter-spacing: .5px;
      border:2.2px solid transparent;
      box-shadow: 0 1px 7px #45fadf22;
      padding: 14px 10px;
      text-decoration: none;
      transition: background 0.16s, color 0.18s, box-shadow 0.12s, border 0.13s;
      outline: none;
      text-align: center;
    }
    .menu-card i { font-size: 1.44em; }
    .menu-card:hover, .menu-card:focus {
      background: var(--footer-link-hover-bg);
      color: #141f36;
      border:2.2px solid var(--footer-border);
      text-decoration: none;
      box-shadow:0 5px 18px #45fadf70;
    }
    @media (max-width: 1100px){
      #game-board{ gap:7px; padding: 10px 2vw;}
      .card{font-size:clamp(1.1em,4.7vw,2em);}
    }
    @media (max-width: 800px) {
      .menu-navegacion{gap:7px;padding:0.7em 0.17em 1em 0.17em;}
      .menu-card{ font-size:1em; padding:11px 3px;}
      #game-board{min-width:90vw;}
      .card{width:clamp(44px,13vw,70px);height:clamp(44px,13vw,70px);}
    }
    @media (max-width:600px){
      .card{min-width:33vw;min-height:33vw;}
      #game-board{padding:3px;gap:5px;}
      h1{font-size:1.08em;}
      #stats{font-size:.99em;}
    }
  </style>

{% endblock %}

{% block content %}
<div>
  <h1>üß† L√≥gica Matem√°tica</h1>
  <div class="menu-juegos">
    <button class="juego-btn selected">L√≥gica Matem√°tica</button>
    <button class="juego-btn" onclick="location.href='{{ url_for('main.memoria') }}'">Memoria inform√°tica</button>
    <button class="juego-btn" onclick="location.href='{{ url_for('main.secuencia_inversa') }}'">Secuencia Inversa</button>
    
  </div>
  <div class="container">
    <div class="enunciado" id="enunciado">Cargando...</div>
    <div class="opciones" id="opciones"></div>
    <div class="feedback" id="feedback"></div>
    <button id="siguiente">Siguiente</button>
    <div class="stat" id="stats"></div>
  </div>
</div>
{% endblock %}

{% block extrascripts %}
<script>
    const NIVELES = [
      { rondas: 5, dificultad: 0 },
      { rondas: 7, dificultad: 1 },
      { rondas: 8, dificultad: 2 }
    ];
    let nivel = 0, ronda = 0, aciertos = 0, errores = 0, tiempos = [], tiempoInicio = 0;
    let retoActual;

    function mezclar(arr) {
      let a = arr.slice();
      for(let i=a.length-1; i>0; i--) {
        let j = Math.floor(Math.random()*(i+1));
[a[i], a[j]] = [a[j], a[i]];

      }
      return a;
    }

    function retoSecuencia(dif=0) {
      let base = Math.floor(Math.random() * 8) + 2;
      let inc = [1,2,3,4][Math.floor(Math.random()*4)];
      let patt = {0: x=>base+x*inc, 1: x=>base+x*inc*2, 2: x=>base-Math.floor(x/2)*inc }[dif];
      let len = 4 + dif;
      let arr = Array.from({length: len}, (_,i)=>patt(i));
      let respuesta = arr[arr.length-1] + (patt(1)-patt(0));
      arr[arr.length-1] = "?";
      return {
        enunciado: `¬øQu√© n√∫mero completa?<br><b>${arr.join(", ")}</b>`,
        opciones: mezclar([respuesta, respuesta+inc, respuesta-inc, respuesta+2]).slice(0,4),
        correcta: respuesta
      };
    }

    function retoOperador(dif=0) {
      let a = Math.floor(Math.random()*12 + 2 + dif*4);
      let b = Math.floor(Math.random()*12 + 2 + dif*4);
      let ops = [
        {op:"+",f:(x,y)=>x+y},
        {op:"-",f:(x,y)=>x-y},
        {op:"√ó",f:(x,y)=>x*y},
        {op:"√∑",f:(x,y)=>Math.floor(x/y)}
      ];
      let op = ops[Math.floor(Math.random()*((dif>1)?4:3))];
      let val = op.f(a,b);
      return {
        enunciado: `¬øQu√© operador hace esto cierto?<br><b>${a} [ ? ] ${b} = ${val}</b>`,
        opciones: mezclar([op.op, ...ops.filter(o=>o.op!=op.op).map(o=>o.op)]),
        correcta: op.op
      }
    }

    function retoExprCorrecta(dif=0) {
      let a = Math.floor(Math.random()*10+2+dif*5);
      let b = Math.floor(Math.random()*10+2+dif*5);
      let c = Math.floor(Math.random()*10+1+dif*7);
      let exprs = [
        `${a} + ${b} = ${a+b}`,
        `${a} - ${b} = ${a-b}`,
        `${a} x ${b} = ${a*b}`,
        `${a} + ${b} = ${a*c}`,
        `${a} - ${b} = ${c}`,
        `${a} x ${b} = ${a*b+1}`
      ];
      let buenas = exprs.slice(0,3);
      let mezcladas = mezclar(exprs).slice(0,4);
      let correcta = mezcladas.find(e => buenas.includes(e));
      return {
        enunciado: `¬øCu√°l es verdadera?`,
        opciones: mezcladas,
        correcta: correcta
      };
    }

    function generaReto(dif=0) {
      let pick = Math.random();
      if(pick < 0.34) return retoSecuencia(dif);
      else if(pick < 0.67) return retoOperador(dif);
      else return retoExprCorrecta(dif);
    }

    function nuevaRonda() {
      if(ronda >= NIVELES[nivel].rondas) return resumen();

      document.getElementById('siguiente').style.display = 'none';
      document.getElementById('feedback').innerHTML = '';
      retoActual = generaReto(NIVELES[nivel].dificultad);
      document.getElementById('enunciado').innerHTML = `<b>Reto ${ronda+1} de ${NIVELES[nivel].rondas}</b><br>${retoActual.enunciado}`;
      const cont = document.getElementById('opciones');
      cont.innerHTML = '';
      retoActual.opciones.forEach(op => {
        const b = document.createElement('button');
        b.className = 'op-btn';
        b.textContent = op;
        b.onclick = ()=>validaRespuesta(op, b);
        cont.appendChild(b);
      });
      tiempoInicio = performance.now();
    }

    function validaRespuesta(resp, btn) {
      const t = performance.now() - tiempoInicio;
      tiempos.push(t);
      const cor = (resp == retoActual.correcta);
      if(cor) aciertos++; else errores++;

      document.getElementById('feedback').innerHTML = cor
        ? '<div class="correcto">‚úÖ ¬°Correcto!</div>'
        : `<div class="fallo">‚ùå Incorrecto. Era: <b>${retoActual.correcta}</b></div>`;

      document.querySelectorAll('.op-btn').forEach(b=>{
        b.disabled = true;
        if(b.textContent == retoActual.correcta) b.style.background = "#00ffb0";
      });

      const btnNext = document.getElementById('siguiente');
      btnNext.textContent = (ronda+1 >= NIVELES[nivel].rondas)
        ? (nivel+1<NIVELES.length?"Siguiente nivel":"Reiniciar")
        : "Siguiente";
      btnNext.style.display = 'inline-block';
      btnNext.onclick = ()=>{
        if(ronda+1 >= NIVELES[nivel].rondas) {
          if(nivel+1 < NIVELES.length) { nivel++; }
          else { nivel = 0; tiempos = []; }
          ronda = 0; aciertos=0; errores=0;
        } else ronda++;
        nuevaRonda();
      };
      actualizaStats();
    }

    function resumen() {
      document.getElementById('enunciado').innerHTML = '<b>¬°Juego completado!</b>';
      document.getElementById('opciones').innerHTML = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('siguiente').style.display = 'inline-block';
      document.getElementById('siguiente').textContent = 'Reiniciar';
      document.getElementById('siguiente').onclick = () => {
        nivel = 0; ronda = 0; aciertos=0; errores=0; tiempos = [];
        nuevaRonda();
      };
      actualizaStats();
    }

    function actualizaStats() {
      let html = `<b>Aciertos:</b> ${aciertos} &nbsp;&nbsp; <b>Errores:</b> ${errores}<br>`;
      if (tiempos.length) {
        let avg = Math.round(tiempos.reduce((a, b) => a + b, 0) / tiempos.length);
        let best = Math.min(...tiempos);
        html += `<b>Mejor:</b> ${best} ms &nbsp; <b>Media:</b> ${avg} ms`;
      }
      document.getElementById('stats').innerHTML = html;
    }

    window.onload = () => {
      nivel = 0; ronda = 0; aciertos = 0; errores = 0; tiempos = [];
      nuevaRonda();
    };
  </script>
{% endblock %}
