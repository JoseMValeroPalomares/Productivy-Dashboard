{% extends "base.html" %}

{% block title %}üéØ Tus Metas{% endblock %}

{% block extra_css %}
<style>
  .goals-section {
    max-width: 840px;
    margin: 3rem auto;
    background: var(--card);
    border-radius: var(--radius);
    padding: 2.5rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(10px);
    animation: fadeIn 0.5s ease;
  }

  .centered-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--primary-light);
    text-align: center;
    margin-bottom: 2.2rem;
  }

  /* Barra de progreso (mejorada) */
  .progress-container {
    margin-top: 2.5rem;
    margin-bottom: 3rem;
    padding: 0.9rem 1rem 1rem 1rem;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: 0px 3px 10px rgba(7, 62, 66, 0.719);
    text-align: center;
    user-select: none;
  }
  .progress-counter {
    font-size: 1.18rem;
    font-weight: 700;
    color: var(--primary);
    letter-spacing: 1px;
    margin-top: 0.2rem;
    margin-bottom: 0.8rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .progress-counter i {
    color: var(--accent);
    font-size: 1.3rem;
  }
  .progress-bar-bg {
    width: 100%;
    background: linear-gradient(90deg, #222932 0%, #197a7b 100%);
    height: 24px;
    border-radius: 30px;
    box-shadow:
      inset 0 2px 6px rgba(0, 0, 0, 0.3),
      0 4px 10px rgb(0 255 199 / 0.30);
    overflow: hidden;
    position: relative;
  }
  .progress-bar-actual {
    height: 100%;
    transition: width 0.5s cubic-bezier(.55,0,.1,1), background 0.66s;
    background: linear-gradient(90deg, #34e5a6 0%, #74f2ce 50%, #2fa5ff 100%);
    border-radius: 15px 0 0 15px;
    box-shadow: 0 2px 8px #2fc0ffaa;
    position: relative;
    z-index: 1;
  }

  /* Selector de categor√≠as tipo chips + bot√≥n integrados */
  .input-category-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.2rem;
  }

  .category-chips {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    max-width: 300px;
    justify-content: center;
    margin-left: auto;
    margin-right: auto;
  }
  .chip {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 18px;
    padding: 0.44rem 1.3rem;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    transition: filter 0.15s;
    outline-offset: 2px;
    position: relative;
    
  }
  .chip.selected,
  .chip:hover,
  .chip:focus-visible {
    filter: brightness(1.15) drop-shadow(0 3px 9px #27eafd52);
    background: var(--primary);
    outline: none;
  }
  .chip-add {
    background: #197a7b;
    color: white;
    border: none;
    font-weight: 700;
    font-size: 1.3rem;
    padding: 0.4rem 1rem;
    border-radius: 18px;
    cursor: pointer;
    transition: background 0.2s ease;
    user-select: none;
    box-shadow: 0 2px 6px rgba(0, 128, 128, 0.4);
  }
  .chip-add:hover,
  .chip-add:focus-visible {
    background: #0f5858;
    outline: none;
    box-shadow: 0 3px 9px #0cc3bbcc;
  }

  .goal-form {
    display: flex;
    flex-grow: 1;
    border-radius: var(--radius);
    background: rgba(37, 55, 99, 0.4);
    box-shadow: 0 0 12px rgba(0, 255, 199, 0.21);
    overflow: hidden;
    margin-bottom: 40px;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
    width: 100%;
  }
  @media (max-width: 650px) {
    .goal-form {
      max-width: 100%;
    }
  }
  
  .goal-form input[type="text"] {
    flex: 1;
    padding: 0.87rem 1rem;
    font-size: 1.07rem;
    border: none;
    background: transparent;
    color: var(--text);
    outline: none;
    transition: background 0.17s;
  }
  .goal-form input[type="text"]:focus {
    background: #35507b;
  }
  .goal-form button[type="submit"] {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: white;
    border: none;
    padding: 0 1.3rem;
    cursor: pointer;
    font-weight: 700;
    font-size: 1.13rem;
    transition: filter 0.19s ease, background 0.3s;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
  }
  .goal-form button[type="submit"]:hover {
    filter: brightness(1.16);
    background: linear-gradient(135deg, var(--accent) 60%, var(--primary) 100%);
  }

  #goalInputHelp {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-top: 0.4rem;
    margin-left: 5px;
    
  }

  .goal-list {
    list-style: none;
    margin: 0 0 3rem 0;
    padding: 0;
    min-height: 21px;
  }
  .goal-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.1rem 1.3rem;
    margin-bottom: 1rem;
    border-radius: var(--radius);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 1px 6px rgba(27, 233, 253, 0.1);
    cursor: grab;
    user-select: none;
    transition: all 0.3s ease;
  }
  .goal-item:hover {
    background: rgba(255, 255, 255, 0.05);
    box-shadow: 0 4px 15px rgba(27, 233, 253, 0.25);
  }
  .goal-item.done {
    text-decoration: line-through;
    opacity: 0.6;
    color: #7dd172;
    background: linear-gradient(90deg, #5fffa0 0%, #e0ffe5 100%);
    box-shadow: 0 0 8px 2px rgba(34, 211, 101, 0.18) inset;
    transition: background 0.5s cubic-bezier(.17,1.18,.73,1.05);
  }
  .goal-item.confetti-animate {
    animation: pop-done 0.5s cubic-bezier(.28,1.3,.42,.87);
  }
  @keyframes pop-done {
    0% {
      transform: scale(1);
      filter: brightness(1.1);
    }
    50% {
      transform: scale(1.07);
      filter: brightness(1.25);
    }
    70% {
      transform: scale(0.97);
    }
    100% {
      transform: none;
    }
  }

  .goal-description {
    flex: 1;
    font-size: 1.05rem;
    word-break: break-word;
  }
  .goal-actions {
    display: flex;
    gap: 0.6rem;
    margin-left: 1rem;
    flex-shrink: 0;
  }
  .goal-actions button {
    background: transparent;
    border: none;
    color: var(--accent);
    font-size: 1.25rem;
    cursor: pointer;
    padding: 0.3rem;
    border-radius: var(--radius);
    transition: background 0.2s ease;
  }
  .goal-actions button:hover {
    background: var(--primary);
    color: #fff;
  }

  /* Modal */
  #editModal, #categoryModal, #deleteConfirmModal {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 300;
  }
  #editModal.active, #categoryModal.active, #deleteConfirmModal.active {
    display: flex;
  }
  #editModal .modal-content, #categoryModal .modal-content, #deleteConfirmModal .modal-content {
    background: var(--card);
    border-radius: var(--radius);
    padding: 2rem;
    width: 92%;
    max-width: 430px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    color: var(--text);
  }
  #editModal h2, #categoryModal h2, #deleteConfirmModal h2 {
    margin-bottom: 1.2rem;
    font-size: 1.5rem;
    color: var(--primary-light);
  }
  #editModal input,
  #editModal select,
  #categoryModal input  {
    padding: 0.7rem 1rem;
    font-size: 1rem;
    background: rgba(37, 55, 99, 0.5);
    border: none;
    border-radius: var(--radius);
    color: var(--text);
    width: 100%;
    margin-bottom: 1rem;
    outline-offset: 0;
  }
  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
  }
  .save-btn {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    padding: 0.6rem 1.2rem;
    font-weight: bold;
    cursor: pointer;
  }
  .save-btn:hover {
    background: var(--accent);
  }
  .cancel-btn {
    background: #4b557b;
    color: #fff;
    border: none;
    border-radius: var(--radius);
    padding: 0.6rem 1.2rem;
    cursor: pointer;
  }
  .cancel-btn:hover {
    background: #5f6d9c;
  }
  #deleteCategoryBtn {
    background: #c0392b;
    color: white;
  }
  /* Responsive */
  @media (max-width: 650px) {
    .goals-section {
      padding: 1.5rem 1rem;
      margin: 1.5rem 1rem;
    }
    .goal-form {
      flex-direction: column;
    }
    .goal-actions {
      gap: 0.3rem;
    }
    .goal-item {
      flex-direction: column;
      align-items: flex-start;
    }
    .goal-actions {
      margin-top: 0.8rem;
      justify-content: flex-end;
      width: 100%;
    }
  }
  
  .custom-modal {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.86);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
}
.custom-modal.active,
.custom-modal[style*="flex"] {
  display: flex !important;
}
.custom-modal .modal-content {
  background: var(--card);
  border-radius: var(--radius);
  padding: 2rem;
  width: 92%;
  max-width: 420px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.26);
  color: var(--text);
}

/* ...existing code... */
.goal-item.sortable-chosen {
  box-shadow: 0 8px 24px #2fa5ff77, 0 0 0 3px var(--accent);
  background: linear-gradient(90deg, #2fa5ff22 0%, #34e5a6 100%);
  transform: scale(1.04) rotate(-1deg);
  transition: box-shadow 0.2s, background 0.2s, transform 0.2s;
  z-index: 10;
}
.goal-item.sortable-ghost {
  opacity: 0.45;
  background: repeating-linear-gradient(
    135deg,
    #2fa5ff22,
    #2fa5ff22 10px,
    #34e5a622 10px,
    #34e5a622 20px
  );
  border: 2px dashed var(--accent);
  transition: opacity 0.2s, background 0.2s;
}
/* ...existing code... */

</style>
{% endblock %}

{% block content %}
<section class="goals-section" aria-label="Gesti√≥n de metas personales">
  <h1 class="centered-title">üéØ Tus metas personales</h1>

  <!-- Barra de progreso -->
  <div class="progress-container" id="progressSummary">
    <span class="progress-counter" aria-live="polite" aria-atomic="true">
      <i class="fa fa-flag-checkered"></i> 
      <strong id="completedCount">{{ completed_goals }}</strong> / 
      <span id="totalCount">{{ total_goals }}</span> metas completadas
    </span>
    <div class="progress-bar-bg" role="progressbar" aria-valuemin="0" aria-valuemax="{{ total_goals }}" aria-valuenow="{{ completed_goals }}">
      <div class="progress-bar-actual" id="progressBar" style="width: {{ completion_percent }}%;"></div>
    </div>
  </div>

<form class="goal-form-linear" id="goalForm" autocomplete="off" aria-label="Formulario para a√±adir nuevas metas" method="post" action="" style="max-width: 420px; margin: 2rem auto 1rem auto; display: flex; flex-direction: column; gap: 1.2rem;">
  <input 
    type="text" 
    name="description" 
    id="goalInput" 
    placeholder="Ej: Aprender Python" 
    required 
    aria-required="true" 
    autocomplete="off" 
    aria-describedby="goalInputHelp"
    style="padding: 0.9rem 1rem; font-size: 1.1rem; border-radius: var(--radius); border: 1.5px solid #ccc; background: var(--card); color: var(--text); transition: border-color 0.3s ease;"
  >

  <input 
    type="hidden" 
    name="category" 
    id="goalCategory" 
    value="{{ default_category_id }}"
  >

  <button 
    type="submit" 
    aria-label="A√±adir nueva meta" 
    style="background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; font-weight: 700; font-size: 1.15rem; padding: 0.8rem 1.2rem; border: none; border-radius: var(--radius); cursor: pointer; transition: filter 0.25s ease, background 0.4s; box-shadow: 0 3px 10px rgba(0, 255, 199, 0.5);"
    onmouseover="this.style.filter='brightness(1.18)';"
    onmouseout="this.style.filter='none';"
  >
    <i class="fa fa-plus"></i> A√±adir
  </button>
</form>


  <!-- Categor√≠as + bot√≥n + input + bot√≥n de a√±adir como unidad visual integrada -->
  <div class="input-category-group" role="group" aria-label="Selector y creaci√≥n de categor√≠as">
    <div id="categorySelector" class="category-chips" aria-label="Selecciona categor√≠a para la nueva meta">
      <!-- Categor√≠a General como chip sin bot√≥n de editar -->
      <button type="button" class="chip {% if default_category_id == 0 %}selected{% endif %}" 
              data-value="0" aria-pressed="{% if default_category_id == 0 %}true{% else %}false{% endif %}" tabindex="0">
        General
      </button>

      {% for category in categories if category.name and category.name|trim and category.name|lower not in ['sin categor√≠a', 'undefined'] %}
        <button type="button" class="chip {% if category.id == default_category_id %}selected{% endif %}" tabindex="0"
                data-value="{{ category.id }}" aria-pressed="{% if category.id == default_category_id %}true{% else %}false{% endif %}">
          {{ category.name|capitalize }}
        </button>
      {% endfor %}
      <button type="button" id="addCategoryBtn" class="chip chip-add" title="Nueva categor√≠a" aria-label="A√±adir nueva categor√≠a" tabindex="0">+</button>
    </div>

    
  </div>
  <small id="goalInputHelp" style="color: var(--text-secondary); margin: 1.8rem 0 1.6rem 0; display: block; text-align: center;">
    Escribe una meta, elige una categor√≠a y pulsa a√±adir.
  </small>

  <div style="display: flex; justify-content: center; margin-bottom: 1.1rem;">
    <button 
      id="removeEmptyCategoriesBtn" 
      type="button" 
      class="chip chip-add"
      style="padding-left: 1.4rem; padding-right: 1.4rem; gap: 0.6rem; display: inline-flex; align-items: center;"
    >
      <i class="fa fa-trash"></i>
      Eliminar categor√≠as vac√≠as
    </button>
  </div>

    <!-- Metas agrupadas por categor√≠a -->
{% for category, grouped_goals in goals_by_category.items() %}
  {% if category and category|lower not in ['sin categor√≠a', 'undefined'] %}
    <h2 class="goal-category-title" style="margin-top: 2rem; color: var(--primary-light); font-size: 1.3rem;">
      {{ category | capitalize }}
    </h2>
    

    <ul class="goal-list" id="goalList-{{ category|lower }}">
      {% for goal in grouped_goals %}
        <li class="goal-item {% if goal.completed %}done{% endif %}" data-id="{{ goal.id }}" draggable="true" tabindex="0" aria-label="Meta: {{ goal.description }}">
          <div class="goal-description">{{ goal.description }}</div>
          <small style="font-size: 0.75rem; color: var(--text-secondary);">Creada el {{ goal.created_at.strftime('%d/%m/%Y') }}</small>
          <div class="goal-actions">
            <button class="complete-goal" data-id="{{ goal.id }}" aria-label="Completar o eliminar meta">
              <i class="fa fa-check"></i>
            </button>
            <button class="edit-goal" data-id="{{ goal.id }}" aria-label="Editar meta">
              <i class="fa fa-edit"></i>
            </button>
            <button class="delete-goal" data-id="{{ goal.id }}" aria-label="Eliminar meta">
              <i class="fa fa-trash"></i>
            </button>
            <button class="move-up" data-id="{{ goal.id }}" aria-label="Mover meta hacia arriba">
              <i class="fa fa-chevron-up"></i>
            </button>
            <button class="move-down" data-id="{{ goal.id }}" aria-label="Mover meta hacia abajo">
              <i class="fa fa-chevron-down"></i>
            </button>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
{% endfor %}

  <!-- Modal edici√≥n meta -->
  <div id="editModal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle" aria-hidden="true">
    <div class="modal-content">
      <h2 id="editModalTitle">Editar meta</h2>
      <input type="text" id="editGoalInput" aria-label="Editar descripci√≥n meta" required autocomplete="off">
      <select id="editGoalCategory" aria-label="Categor√≠a meta">
        {% for category in categories if category.name and category.name|trim and category.name|lower not in ['sin categor√≠a', 'undefined'] %}
          <option value="{{ category.id }}">{{ category.name|capitalize }}</option>
        {% endfor %}
      </select>
      <div class="modal-actions">
        <button type="button" class="save-btn" id="saveEditBtn" aria-label="Guardar cambios de la meta">Guardar</button>
        <button type="button" class="cancel-btn" id="cancelEditBtn" aria-label="Cancelar edici√≥n">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal gesti√≥n categor√≠as -->
  <div id="categoryModal" role="dialog" aria-modal="true" aria-labelledby="categoryModalTitle" aria-hidden="true">
    <div class="modal-content">
      <h2 id="categoryModalTitle">Gestionar Categor√≠a</h2>
      <input type="text" id="categoryNameInput" aria-label="Nombre de la categor√≠a" required autocomplete="off" placeholder="Nombre de la categor√≠a">
      <div class="modal-actions">
        <button type="button" class="save-btn" id="saveCategoryBtn">Guardar</button>
        <button type="button" class="cancel-btn" id="cancelCategoryBtn">Cancelar</button>
        <button type="button" class="cancel-btn" id="deleteCategoryBtn" style="display:none;">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Modal confirmaci√≥n eliminar meta -->
  <div id="deleteConfirmModal" role="dialog" aria-modal="true" aria-labelledby="deleteConfirmTitle" aria-hidden="true">
    <div class="modal-content">
      <h2 id="deleteConfirmTitle">Eliminar meta</h2>
      <p>¬øSeguro que quieres eliminar esta meta?</p>
      <div class="modal-actions">
        <button type="button" class="save-btn" id="confirmDeleteBtn">Eliminar</button>
        <button type="button" class="cancel-btn" id="cancelDeleteBtn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal personalizado para eliminar categor√≠as vac√≠as -->
<div id="removeEmptyModal" class="custom-modal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="removeEmptyTitle">
  <div class="modal-content">
    <h2 id="removeEmptyTitle" style="margin-bottom:1.2rem;">Eliminar categor√≠as vac√≠as</h2>
    <div id="removeEmptyModalContent" style="margin-bottom:1.2rem;">
      <!-- Aqu√≠ se mostrar√° la lista de categor√≠as vac√≠as detectadas -->
    </div>
    <div class="modal-actions">
      <button type="button" class="save-btn" id="confirmRemoveEmptyBtn">Eliminar</button>
      <button type="button" class="cancel-btn" id="cancelRemoveEmptyBtn">Cancelar</button>
    </div>
  </div>
</div>


</section>
{% endblock %}

{% block extra_js %}
<script>
// --------------------
// Eliminar categor√≠as vac√≠as ‚Äì SOLO MODAL PROPIO
// --------------------
const btnRemoveEmpty = document.getElementById('removeEmptyCategoriesBtn');
const modalRemoveEmpty = document.getElementById('removeEmptyModal');
const modalContentRemoveEmpty = document.getElementById('removeEmptyModalContent');
const btnConfirmRemoveEmpty = document.getElementById('confirmRemoveEmptyBtn');
const btnCancelRemoveEmpty = document.getElementById('cancelRemoveEmptyBtn');

let categoriesToDelete = [];

btnRemoveEmpty.addEventListener('click', () => {
  const allCategoryLists = document.querySelectorAll('ul.goal-list');
  categoriesToDelete = [];
  allCategoryLists.forEach(ul => {
    if (ul.children.length === 0) {
      const titleElem = ul.previousElementSibling;
      if (titleElem && titleElem.classList.contains('goal-category-title')) {
        const catName = titleElem.textContent.trim();
        // NUNCA incluir "General" (ni may√∫sculas ni min√∫sculas)
        if (catName.toLowerCase() !== "general") {
          // Buscar el id en los chips
          const chip = Array.from(document.querySelectorAll('.chip[data-value]'))
            .find(c => c.textContent.trim() === catName && c.dataset.value !== "0");
          if (chip) {
            categoriesToDelete.push({ id: chip.dataset.value, name: catName });
          }
        }
      }
    }
  });

  if (categoriesToDelete.length === 0) {
    modalContentRemoveEmpty.innerHTML = `<span style="color:var(--text-secondary)">
      No hay categor√≠as vac√≠as para eliminar.
    </span>`;
    btnConfirmRemoveEmpty.style.display = "none";
  } else {
    modalContentRemoveEmpty.innerHTML = `
      Se eliminar√°n las siguientes categor√≠as vac√≠as:
      <ul style="padding-left: 1.3em; margin: 0.7em 0 0.5em 0;">
        ${categoriesToDelete.map(cat => `<li style="margin-bottom:0.2em; font-weight:700; color:var(--accent);">${cat.name}</li>`).join('')}
      </ul>
      ¬øQuieres continuar?
    `;
    btnConfirmRemoveEmpty.style.display = "";
  }
  modalRemoveEmpty.style.display = "flex";
});

btnCancelRemoveEmpty.addEventListener('click', () => {
  modalRemoveEmpty.style.display = "none";
});

btnConfirmRemoveEmpty.addEventListener('click', async () => {
  btnConfirmRemoveEmpty.disabled = true;
  try {
    let errors = [];
    for (const cat of categoriesToDelete) {
      const res = await fetch(`/api/categories/${cat.id}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      });
      if (!res.ok) errors.push(cat.name);
    }
    if (errors.length === 0) {
      modalContentRemoveEmpty.innerHTML = `<span style="color:var(--primary-light);font-weight:700;">Categor√≠as vac√≠as eliminadas correctamente.</span>`;
      setTimeout(() => window.location.reload(), 1200);
    } else {
      modalContentRemoveEmpty.innerHTML = `<span style="color:#ff5959;">Error eliminando: ${errors.join(', ')}</span>`;
    }
  } catch (err) {
    modalContentRemoveEmpty.innerHTML = `<span style="color:#ff5959;">Error eliminando categor√≠as: ${err.message}</span>`;
  } finally {
    btnConfirmRemoveEmpty.disabled = false;
  }
});
// --------------------
// Fin eliminar categor√≠as vac√≠as
// --------------------

</script>


<!-- SortableJS para drag & drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- canvas-confetti para animaci√≥n -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
  let editingGoalId = null;

  const catChips = document.querySelectorAll('.chip[data-value]');
  const catInput = document.getElementById('goalCategory');

  // Modal categor√≠as y confirmaci√≥n eliminar meta
  const categoryModal = document.getElementById('categoryModal');
  const categoryNameInput = document.getElementById('categoryNameInput');
  const saveCategoryBtn = document.getElementById('saveCategoryBtn');
  const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');
  const deleteCategoryBtn = document.getElementById('deleteCategoryBtn');

  let editingCategoryId = null;

  const deleteConfirmModal = document.getElementById('deleteConfirmModal');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

  let deletingGoalId = null;
  let deletingGoalLi = null;

  // Selecci√≥n categor√≠a
  catChips.forEach(chip => {
    chip.addEventListener('click', () => {
      catChips.forEach(c => {
        c.classList.remove('selected');
        c.setAttribute('aria-pressed', 'false');
      });
      chip.classList.add('selected');
      chip.setAttribute('aria-pressed', 'true');
      catInput.value = chip.dataset.value;
    });

    chip.addEventListener('dblclick', e => {
      if (chip.dataset.value === "0") return;
      editingCategoryId = chip.dataset.value;
      categoryNameInput.value = chip.textContent.trim();
      deleteCategoryBtn.style.display = 'inline-block';
      categoryModal.classList.add('active');
      categoryNameInput.focus();
    });
  });

  if (!catInput.value && catChips.length) catChips[0].click();

  document.getElementById('addCategoryBtn').addEventListener('click', () => {
    editingCategoryId = null;
    categoryNameInput.value = '';
    deleteCategoryBtn.style.display = 'none';
    categoryModal.classList.add('active');
    categoryNameInput.focus();
  });

  cancelCategoryBtn.addEventListener('click', () => {
    categoryModal.classList.remove('active');
    editingCategoryId = null;
  });

  saveCategoryBtn.addEventListener('click', async () => {
    const name = categoryNameInput.value.trim();
    if (!name) {
      alert('El nombre de la categor√≠a es obligatorio.');
      return;
    }
    try {
      let res;
      if (editingCategoryId) {
        res = await fetch(`/api/categories/${editingCategoryId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
      } else {
        res = await fetch('/api/categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
      }
      if (!res.ok) throw new Error('Error guardando categor√≠a.');
      categoryModal.classList.remove('active');
      window.location.reload();
    } catch (err) {
      alert(err.message);
    }
  });

  deleteCategoryBtn.addEventListener('click', async () => {
    if (!confirm('¬øSeguro que quieres eliminar esta categor√≠a? Se eliminar√°n todas sus metas.')) return;
    try {
      const res = await fetch(`/api/categories/${editingCategoryId}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Error eliminando categor√≠a.');
      categoryModal.classList.remove('active');
      window.location.reload();
    } catch (err) {
      alert(err.message);
    }
  });

  // A√±adir meta con AJAX sin recargar la p√°gina y mostrar categor√≠a si estaba oculta
  document.getElementById('goalForm').addEventListener('submit', async e => {
    e.preventDefault();
    const description = document.getElementById('goalInput').value.trim();
    if (!description) return;
    const category = catInput.value || "{{ default_category_id }}";

    try {
      const res = await fetch('/api/goals', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description, category })
      });
      if (!res.ok) throw new Error('Error al a√±adir la meta.');

      // Mostrar la categor√≠a de la nueva meta si estaba oculta
      // Buscar ul y h2 por id y mostrar (suponemos category como string)
      const catChip = [...catChips].find(c => c.dataset.value === category);
      if (catChip) {
        const catNameLower = catChip.textContent.trim().toLowerCase();

        const ul = document.getElementById('goalList-' + catNameLower);
        if (ul) ul.style.display = 'block';
        if (ul && ul.previousElementSibling && ul.previousElementSibling.classList.contains('goal-category-title')) {
          ul.previousElementSibling.style.display = 'block';
        }
      }

      // Recarga para que meta nueva aparezca (puedes adaptar para insertar en DOM si quieres)
      window.location.reload();
    } catch (err) {
      alert(err.message);
    }
  });

  // Drag & Drop (mantengo como tienes)
  document.querySelectorAll('.goal-list').forEach(ul => {
    new Sortable(ul, {
      animation: 180,
      handle: '.goal-description, .goal-actions',
      ghostClass: 'sortable-ghost',
      onEnd: async evt => {
        const ids = Array.from(evt.to.children).map(li => li.dataset.id);
        try {
          const res = await fetch('/api/goals/reorder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(ids.map((id, idx) => ({ id: Number(id), order: idx + 1 })))
          });
          if (!res.ok) throw new Error('Error actualizando orden.');
        } catch (err) {
          alert(err.message);
        }
      }
    });
  });

  // Delegaci√≥n eventos en metas
  document.querySelector('section.goals-section').addEventListener('click', async e => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const id = btn.dataset.id;
    if (!id) return;

    const li = btn.closest('li.goal-item');
    if (!li) return;

    if (btn.classList.contains('complete-goal')) {
      const isDone = li.classList.contains('done');
      if (!isDone) {
        try {
          const res = await fetch(`/api/goals/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ completed: true })
          });
          if (!res.ok) throw new Error('Error marcando completada.');

          li.classList.add('done', 'confetti-animate');
          confetti({ particleCount: 100, spread: 80, origin: { y: 0.6 } });
          setTimeout(() => li.classList.remove('confetti-animate'), 600);
          updateProgressBar();
        } catch (err) {
          alert(err.message);
        }
      } else {
        deletingGoalId = id;
        deletingGoalLi = li;
        document.getElementById('deleteConfirmTitle').textContent = 'Eliminar meta completada';
        deleteConfirmModal.classList.add('active');
      }
      return;
    }

    if (btn.classList.contains('edit-goal')) {
      openEditModal(id);
      return;
    }

    if (btn.classList.contains('delete-goal')) {
      deletingGoalId = id;
      deletingGoalLi = li;
      document.getElementById('deleteConfirmTitle').textContent = 'Eliminar meta';
      deleteConfirmModal.classList.add('active');
      return;
    }

    if (btn.classList.contains('move-up') || btn.classList.contains('move-down')) {
      const ul = li.parentElement;
      const index = Array.from(ul.children).indexOf(li);
      const direction = btn.classList.contains('move-up') ? -1 : 1;
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= ul.children.length) return;

      if (direction === -1) {
        ul.insertBefore(li, ul.children[newIndex]);
      } else {
        ul.insertBefore(li, ul.children[newIndex].nextSibling);
      }

      const ids = Array.from(ul.children).map(li => li.dataset.id);
      try {
        const res = await fetch('/api/goals/reorder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ids.map((id, idx) => ({ id: Number(id), order: idx + 1 })))
        });
        if (!res.ok) throw new Error('Error actualizando orden al mover.');
      } catch (err) {
        alert(err.message);
      }
      return;
    }
  });

  cancelDeleteBtn.addEventListener('click', () => {
    deletingGoalId = null;
    deletingGoalLi = null;
    deleteConfirmModal.classList.remove('active');
  });

  confirmDeleteBtn.addEventListener('click', async () => {
    if (!deletingGoalId) return;

    try {
      const res = await fetch(`/api/goals/${deletingGoalId}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Error eliminando meta.');

      if (deletingGoalLi) {
        // Eliminamos el li de la meta
        deletingGoalLi.remove();

        // Revisamos si la categor√≠a qued√≥ vac√≠a y ocultamos t√≠tulo + lista (sin eliminar)
        const ul = deletingGoalLi.closest('ul.goal-list');
        if (ul && ul.children.length === 0) {
          const categoryTitle = ul.previousElementSibling;
          if (categoryTitle && categoryTitle.classList.contains('goal-category-title')) {
            categoryTitle.style.display = 'none';
            ul.style.display = 'none';
            // No eliminar chips para mantener categor√≠a en selector y backend
          }
        }
      }
      updateProgressBar();
    } catch (err) {
      alert(err.message);
    }
    deletingGoalId = null;
    deletingGoalLi = null;
    deleteConfirmModal.classList.remove('active');
  });

  function openEditModal(id) {
    editingGoalId = id;
    const li = document.querySelector(`li.goal-item[data-id='${id}']`);
    if (!li) return;

    document.getElementById('editGoalInput').value =
      li.querySelector('.goal-description').textContent.trim();

    const catElem = li.closest('ul.goal-list').previousElementSibling;
    let catId = "{{ default_category_id }}";
    if (catElem && catElem.classList.contains('goal-category-title')) {
      const catName = catElem.textContent.trim().toLowerCase();
      const chip = [...document.querySelectorAll('.chip')].find(c =>
        c.textContent.trim().toLowerCase() === catName);
      if (chip) catId = chip.dataset.value;
    }
    document.getElementById('editGoalCategory').value = catId;

    document.getElementById('editModal').classList.add('active');
    document.getElementById('editGoalInput').focus();
  }

  document.getElementById('cancelEditBtn').addEventListener('click', () => {
    editingGoalId = null;
    document.getElementById('editModal').classList.remove('active');
  });

  document.getElementById('saveEditBtn').addEventListener('click', async () => {
    const descInput = document.getElementById('editGoalInput');
    const catSelect = document.getElementById('editGoalCategory');
    const description = descInput.value.trim();
    const category = catSelect.value;

    if (!description) {
      alert('La descripci√≥n es obligatoria.');
      return;
    }
    try {
      const res = await fetch(`/api/goals/${editingGoalId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ description, category }),
      });
      if (!res.ok) throw new Error('Error guardando meta.');

      editingGoalId = null;
      document.getElementById('editModal').classList.remove('active');
      window.location.reload();
    } catch (err) {
      alert(err.message);
    }
  });

  function updateProgressBar() {
    const completed = document.querySelectorAll('.goal-item.done').length;
    const total = document.querySelectorAll('.goal-item').length;
    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

    document.getElementById('completedCount').textContent = completed;
    document.getElementById('totalCount').textContent = total;
    const bar = document.getElementById('progressBar');
    bar.style.width = percent + '%';

    if (percent === 100)
      bar.style.background = 'linear-gradient(90deg, gold, #36e2ff 50%, gold 100%)';
    else
      bar.style.background = 'linear-gradient(90deg, #34e5a6 0%, #74f2ce 50%, #2fa5ff 100%)';
  }
  window.addEventListener('DOMContentLoaded', updateProgressBar);
</script>



{% endblock %}