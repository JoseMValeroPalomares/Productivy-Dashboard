{% extends "juegos/base_juegos.html" %}

{% block title %}🔁 Secuencia Inversa{% endblock %}

{% block extrastyle %}
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
<style>
:root {
  --fondo: linear-gradient(120deg,#1e2548 10%,#45fadf 90%);
  --glass: rgba(44, 59, 110, 0.92);
  --carta: #363e63;
  --enlace: #00f5e3;
  --acierto: #2edfa7;
  --fallo: #ff9999;
  --error: #e6785b;
  --click: #19fbde;
  --azul-claro: #34fcf2;
  --secuencia-bg: #222c4e;
  --burbuja: #212b4b;
  --footer-bg: rgba(32,44,76,0.93);
  --footer-border: #3ffbda;
  --footer-link: #36f1cc;
  --footer-link-hover-bg: linear-gradient(90deg,#43ffd0 0%,#1d4d6e 100%);
}

* { box-sizing: border-box; }

html, body {
  margin: 0; padding: 0;
  min-width: 100vw; min-height: 100vh;
  width: 100vw; height: 100vh;
  overflow-x: hidden;
  background: var(--fondo);
  color: #f1feff;
  font-family: 'Share Tech Mono', monospace, Arial, sans-serif;
  display: flex; flex-direction: column;
  align-items: stretch; justify-content: flex-start;
}

h1 {
  margin: 2rem 0 0.7rem 0;
  text-align: center;
  color: #3ffbda;
  font-size: clamp(1.3em,4vw,2.2em);
  letter-spacing: 2px;
  text-shadow: 0 2px 16px #283a5a77;
}

#menu-juegos {
  display: flex; gap: 12px; flex-wrap: wrap;
  justify-content: center; margin: 18px 0;
}

.juego-btn {
  background: #172a3c;
  border: 2px solid transparent;
  color: #3ffbda;
  font-weight: bold;
  padding: 12px 20px;
  border-radius: 11px;
  cursor: pointer; font-size: 1em;
  transition: all 0.19s ease;
  min-width: 120px;
}
.juego-btn.selected,
.juego-btn:disabled {
  background: var(--enlace);
  color: #202530;
  cursor: default;
  border-color: var(--enlace);
}
.juego-btn:hover:not(.selected):not(:disabled) {
  background: #34fbee33;
  border-color: #34fbeea8;
}

/* Contenedores */
.container {
  background: rgba(35,50,70,0.99);
  border-radius: 18px;
  padding: 23px;
  box-shadow: 0 4px 22px #09fcff20;
  width: 96%; max-width: 440px;
  margin: 24px auto 98px auto;
  display: flex; flex-direction: column; align-items: center;
}

#config {
  margin: 22px 0 8px 0;
  display: flex; gap:13px; flex-wrap:wrap;
  align-items:center; justify-content:center;
  background: var(--glass);
  border-radius: 12px;
  box-shadow:0 2px 17px #00f5ff18;
  padding: 10px 19px;
}
#config label { font-size:1em;font-weight:700; }

/* Secuencia */
.sequence-wrap {
  width: 100%; display: flex;
  justify-content:center; align-items:center;
  min-height: 53px;
}
.secu-step {
  font-size: 2em;
  min-width:46px; min-height:56px;
  margin: 0 6px;
  font-weight: bold;
  background: var(--secuencia-bg);
  color: #fff;
  border-radius: 13px;
  padding: 12px 18px;
  display: flex; align-items:center; justify-content:center;
  box-shadow:0px 3px 15px #10163a44;
  opacity: 0;
  transition: opacity 0.2s, background .32s, box-shadow .21s;
  animation: fadeInShow .38s cubic-bezier(.33,1.56,.37,1) forwards;
}
@keyframes fadeInShow { to { opacity: 1;} }
.secu-step.hide { opacity:0 !important; }

/* Inputs */
.inputs { margin: 20px 0; width: 100%; text-align:center; font-size: 1em; }
.answer-bubble {
  display: inline-block;
  background: var(--burbuja);
  border: 2px solid var(--enlace);
  color: #f4fdff;
  min-width: 31px; min-height: 35px;
  border-radius: 11px;
  font-size: 1.14em;
  margin: 4px;
  text-align: center;
  box-shadow: 0 1px 6px #17fafa33;
  font-weight: bold;
  letter-spacing:0.5px;
  padding: 6px 8px;
  transition: background 0.2s;
}
.answer-bubble.filled { background: #c5e3fa; }

/* Botones y controles */
.calc { text-align: center; margin-top: 7px; }
.calc-btn, .calc-ctrl, button {
  font-size: 1.1em;
  border-radius: 9px; border:none;
  margin: 4px; padding: 13px 17px;
  cursor:pointer;
  font-weight: bold;
  transition: background 0.15s, color 0.16s;
}
.calc-btn {
  background: #253b5b; color: #aefaff;
  width: 54px; height: 54px;
}
.calc-btn:hover:not(:disabled) { background: var(--enlace); color: #192a40; }
.calc-btn:disabled { background:#2b2f38; color: #647186; cursor:not-allowed;}
.calc-ctrl { background: #444; color: #fff; }
.calc-ctrl:hover { background: #c33; }

button {
  background: var(--enlace); color: #191d27;
  margin-top: 13px;
}
button:disabled{ background:#aaa; color: #fff;}

#siguiente, #next-level {
  font-size: 1.1em; margin: 22px auto 0 auto; font-weight:bold;
  border-radius: 10px; padding: 14px 37px;
  box-shadow: 0 2px 15px #3ffbda30;
  display:none;
  transition: background 0.13s, color 0.13s;
}
#siguiente:not(:disabled):hover,
#next-level:not(:disabled):hover {
  background:#57ffe7; color:#192733;
}
#next-level:disabled {
  background: #aac; color: #eee;
  cursor: not-allowed;
  filter: grayscale(.14);
  opacity: .7;
}

/* Mensajes */
.correct { color: var(--acierto); font-weight:bold; margin-top: 13px; }
.fail { color: var(--fallo); font-weight:bold; margin-top: 13px; }

/* Estadísticas */
.stats, #stats {
  margin-top: 17px;
  font-size:1em;
  text-align:center;
  color: #b1fbe6;
  padding: 8px 26px;
  background: #22ebff24;
  border-radius: 8px;
  box-shadow: 0 2px 8px #23ebef13;
}

/* Navegación inferior */
.menu-navegacion {
  width: 100vw;
  display: flex;
  gap: 13px;
  justify-content: center;
  align-items: stretch;
  background: var(--footer-bg);
  box-shadow: 0 -3px 21px #39ffd733;
  padding: 0.8em 0.6em 1.2em 0.8em;
  position: fixed;
  left: 0; right: 0; bottom: 0;
  z-index: 12;
}
.menu-card {
  flex:1;
  display:flex;
  align-items:center; justify-content:center;
  gap: 10px;
  background: none;
  border-radius:14px;
  font-size: 1.16em;
  font-weight:bold;
  color: var(--footer-link);
  letter-spacing: .5px;
  border:2.2px solid transparent;
  box-shadow: 0 1px 7px #45fadf22;
  padding: 14px 10px;
  text-decoration: none;
  transition: background 0.16s, color 0.18s, box-shadow 0.12s, border 0.13s;
  outline: none; text-align: center;
}
.menu-card i { font-size: 1.44em; }
.menu-card:hover, .menu-card:focus {
  background: var(--footer-link-hover-bg);
  color: #141f36;
  border:2.2px solid var(--footer-border);
  text-decoration: none;
  box-shadow:0 5px 18px #45fadf70;
}

/* Responsive */
@media (max-width:1100px){
  #game-board{ gap:7px; padding: 10px 2vw;}
  .card{font-size:clamp(1.1em,4.7vw,2em);}
}
@media (max-width:800px){
  .menu-navegacion{gap:7px;padding:0.7em 0.17em 1em 0.17em;}
  .menu-card{ font-size:1em; padding:11px 3px;}
}
@media (max-width:600px) {
  .calc-btn, .calc-ctrl, button { font-size:.96em; padding:8px; }
  .container{padding:.7em;}
  .menu-card{font-size:1em;}
  .secu-step{font-size:1.2em;min-width:31px;min-height:33px;}
  h1{font-size:1.08em;}
  #stats{font-size:.99em;}
}


.answer-bubble {
  display: inline-block;
  background: var(--burbuja);
  border: 2px solid var(--enlace);
  color: #f4fdff;
  min-width: 31px; min-height: 35px;
  border-radius: 11px;
  font-size: 1.2em;
  margin: 4px;
  text-align: center;
  box-shadow: 0 2px 14px #17fafa50;
  font-weight: bold;
  padding: 7px 10px;
  transition: background 0.2s, box-shadow 0.2s, transform 0.17s;
  position: relative;
  vertical-align: middle;
}

/* Destaca la burbuja actual */
.answer-bubble.active {
  border-color: var(--acierto);
  box-shadow: 0 0 18px #2edfa7aa;
  background: #324e6b;
  transform: scale(1.12);
}

/* Animación al añadir/quitar (solo visual, implementable con JavaScript si lo deseas) */
.answer-bubble.filled {
  background: #2edfa7;
  color: #182226;
  box-shadow: 0 2px 16px #2edfa770;
  animation: popIn .25s cubic-bezier(.63,1.32,.34,.99);
}

@keyframes popIn {
  0% { transform: scale(0.7); }
  70% { transform: scale(1.20); }
  100% { transform: scale(1); }
}

/* Indicador tipo cursor en la burbuja actual */
.answer-bubble.active::after {
  content: '';
  display: inline-block;
  width: 3px; height: 18px;
  background: var(--enlace);
  position: absolute;
  right: 7px; top: 50%;
  transform: translateY(-50%);
  border-radius: 4px;
  animation: blink-cursor 1.1s steps(1) infinite;
}
@keyframes blink-cursor {
  0%, 49% { opacity: 1; }
  50%, 100% { opacity: 0; }
}



</style>

{% endblock %}

{% block content %}
<h1>🔁 Secuencia Inversa</h1>
<div id="menu-juegos">
  <button class="juego-btn" onclick="location.href='{{ url_for('main.calculo_mental') }}'">Lógica Matemática</button>
  <button class="juego-btn" onclick="location.href='{{ url_for('main.memoria') }}'">Memoria informática</button>
  <button class="juego-btn selected">Secuencia inversa</button>
</div>
<div class="container">
  <button id="startBtn">Start</button>
  <div id="nivel" style="display:none;"></div>
  <div class="sequence-wrap" id="sequence-wrap" style="display:none;"></div>
  <div class="inputs" id="inputs" style="display:none;"></div>
  <div class="calc" id="calc" style="display:none;"></div>
  <div class="stats" id="stats"></div>
  <button id="siguiente" style="display:none;"></button>
</div>
{% endblock %}


{% block extrascripts %}
<script>
  const NIVELES = [3,4,5,6,7,8,9,10];
const SHOW_TIME = 750;
let state = { nivel: 0, secuencia: [], respuesta: [], correctas: 0, startTime: 0, tiempos: [], started: false };

function generaSecuencia(n){ return Array.from({length: n}, () => Math.floor(Math.random() * 10)); }
function muestraStats(final=false){
  let html = `<b>Nivel:</b> ${state.nivel+1}/${NIVELES.length}<br>`;
  html += `<b>Correctas:</b> ${state.correctas} / ${state.nivel+1}<br>`;
  if(state.tiempos.length){
    const best = Math.min(...state.tiempos);
    const avg = Math.round(state.tiempos.reduce((a,b)=>a+b)/state.tiempos.length);
    html += `<b>Mejor:</b> ${Math.round(best/1000)}s &nbsp; <b>Media:</b> ${Math.round(avg/1000)}s<br>`;
  }
  if(final){
    const total = Math.round(state.tiempos.reduce((a,b)=>a+b)/1000);
    html += `<b>Juego completado en</b> <b>${total} segundos</b><br>`;
  }
  document.getElementById('stats').innerHTML = html;
}

function muestraNivel(){
  document.getElementById('nivel').style.display = 'block';
  document.getElementById('sequence-wrap').style.display = 'block';
  document.getElementById('inputs').style.display = 'block';
  document.getElementById('calc').style.display = 'block';
  document.getElementById('siguiente').style.display = 'none';
  document.getElementById('nivel').textContent = `Nivel ${state.nivel+1} de ${NIVELES.length}`;
  document.getElementById('inputs').innerHTML = '';
  document.getElementById('calc').innerHTML = '';
  state.secuencia = generaSecuencia(NIVELES[state.nivel]);
  state.respuesta = [];
  mostrarAnimacion(state.secuencia, ()=>{
    state.startTime = performance.now();
    mostrarCalculadora(NIVELES[state.nivel]);
  });
}

function mostrarAnimacion(secuencia, callback){
  let cont = document.getElementById('sequence-wrap');
  let i = 0;
  function anim(){
    if(i < secuencia.length){
      cont.innerHTML = ''; // Elimina cualquier número anterior
      const step = document.createElement('div');
      step.className = "secu-step";
      step.textContent = secuencia[i];
      cont.appendChild(step);
      setTimeout(() => {
        i++;
        anim();
      }, SHOW_TIME);
    } else {
      setTimeout(() => { cont.innerHTML = ''; if(callback) callback(); }, 350);
    }
  }
  anim();
}

function mostrarCalculadora(longitud){
  const inputs = document.getElementById('inputs');
  inputs.innerHTML = 'Secuencia <b>inversa</b>: ';
  for(let i=0; i<longitud; i++){
    const burbuja = document.createElement('span');
    burbuja.className = 'answer-bubble' + (state.respuesta[i] !== undefined ? ' filled' : '');
    burbuja.textContent = state.respuesta[i] ?? '';
    inputs.appendChild(burbuja);
  }
  const calcDiv = document.getElementById('calc');
  calcDiv.innerHTML = '';
  for(let i=1;i<=9;i++){
    const btn = document.createElement('button');
    btn.className = 'calc-btn';
    btn.textContent = i;
    btn.onclick = ()=>introducir(i);
    if(state.respuesta.length >= longitud) btn.disabled = true;
    calcDiv.appendChild(btn);
    if(i%3===0) calcDiv.appendChild(document.createElement('br'));
  }
  const btn0 = document.createElement('button');
  btn0.className = 'calc-btn';
  btn0.textContent = '0'; btn0.onclick=()=>introducir(0);
  if(state.respuesta.length>=longitud) btn0.disabled = true;
  calcDiv.appendChild(btn0);
  const borrar = document.createElement('button');
  borrar.className = 'calc-ctrl'; borrar.textContent = '⌫'; borrar.onclick = borrarEntrada;
  calcDiv.appendChild(borrar);
  if(state.respuesta.length === longitud){
    const check = document.createElement('button');
    check.textContent = 'Comprobar'; check.onclick = comprobar;
    calcDiv.appendChild(check);
  }
}

function introducir(n){
  if(state.respuesta.length < NIVELES[state.nivel]){
    state.respuesta.push(n);
    mostrarCalculadora(NIVELES[state.nivel]);
  }
}
// Mejor visualización: las burbujas no “bajan”, solo se rellenan de izquierda a derecha.

function borrarEntrada(){ state.respuesta.pop(); mostrarCalculadora(NIVELES[state.nivel]); }
function comprobar(){
  const esperado = [...state.secuencia].reverse();
  const correcto = JSON.stringify(esperado) === JSON.stringify(state.respuesta);
  const tiempo = performance.now()-state.startTime;
  state.tiempos.push(tiempo);
  if(correcto) state.correctas++;
  mostrarRespuesta(correcto,esperado);
  const fin = (state.nivel+1)===NIVELES.length;
  const btn = document.getElementById('siguiente');
  btn.style.display='inline-block';
  btn.textContent = fin ? 'Reiniciar Juego' : 'Siguiente Nivel';
  btn.onclick = ()=>{
    if(fin){ state.nivel=0; state.correctas=0; state.tiempos=[]; }
    else { state.nivel++; }
    state.respuesta=[]; muestraNivel(); muestraStats();
  };
  muestraStats(fin && correcto);
}

function mostrarRespuesta(correcto,esperado){
  document.getElementById('inputs').innerHTML = correcto
    ? `<div class="correct">✅ ¡Correcto!</div>`
    : `<div class="fail">❌ Respuesta esperada: <b>${esperado.join(', ')}</b></div>`;
  document.getElementById('calc').innerHTML = '';
}

// La secuencia sólo se muestra tras pulsar “Start”
document.getElementById('startBtn').onclick = function() {
  state.started = true;
  document.getElementById('startBtn').style.display = 'none';
  muestraNivel();
  muestraStats();
};

// El juego NO empieza al abrir, sino tras START.
window.onload = function(){
  state.nivel=0; state.correctas=0; state.respuesta=[]; state.tiempos=[]; state.started=false;
  document.getElementById('nivel').style.display='none';
  document.getElementById('sequence-wrap').style.display='none';
  document.getElementById('inputs').style.display='none';
  document.getElementById('calc').style.display='none';
  document.getElementById('siguiente').style.display='none';
  muestraStats();
};

</script>
{% endblock %}
